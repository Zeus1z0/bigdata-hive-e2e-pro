<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hadoop + Hive 端到端分析（Tips 数据集）</title>
  <link rel="stylesheet" href="assets/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>端到端大数据分析（Hadoop 2.10.2 + Hive 2.3.9）</h1>
    <p class="muted">数据：餐厅小费（tips.csv）。流程：HDFS → Hive（CSV→ORC 分层/分区）→ 数据质量 → 可视化。页面生成时间：<span id="genAt"></span></p>

    <div class="kpis">
      <div class="kpi">
        <div class="muted">样本量（rows）</div>
        <div id="kpiRows" style="font-size:24px;font-weight:700">-</div>
      </div>
      <div class="kpi">
        <div class="muted">整体平均小费率（%）</div>
        <div id="kpiAvg" style="font-size:24px;font-weight:700">-</div>
      </div>
      <div class="kpi">
        <div class="muted">CSV 下载</div>
        <div><a href="assets/by_day.csv" target="_blank">by_day.csv</a> · <a href="assets/by_size.csv"
            target="_blank">by_size.csv</a> · <a href="assets/heatmap.csv" target="_blank">heatmap.csv</a></div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <!-- 第一个卡片：增加了带 id 的 p 标签 -->
      <div class="card">
        <h2>不同工作日平均小费率</h2>
        <p class="muted" id="insight-by-day" style="margin-top:-8px; margin-bottom:12px; font-style: italic;"></p>
        <div id="chartDay" style="height:360px"></div>
      </div>

      <!-- 第二个卡片：增加了带 id 的 p 标签 -->
      <div class="card">
        <h2>不同就餐人数平均小费率</h2>
        <p class="muted" id="insight-by-size" style="margin-top:-8px; margin-bottom:12px; font-style: italic;"></p>
        <div id="chartSize" style="height:360px"></div>
      </div>

      <!-- 第三个卡片：保持不变 -->
      <div class="card" style="grid-column:1/-1">
        <h2>工作日 × 就餐时段 热力图</h2>
        <div id="chartHeat" style="height:420px"></div>
      </div>

      <!-- 第四个卡片：保持不变 -->
      <div class="card" style="grid-column:1/-1">
        <h2>方法与结论</h2>
        <ul>
          <li>CSV 外部表仅作落地；生产表转换为 ORC（SNAPPY）并按 <code>day</code> 分区，添加衍生字段
            <code>tip_pct</code>（百分比）、<code>is_weekend</code>。</li>
          <li>质量检查覆盖负数/越界/关键空值；若存在违规会在流水线中告警并可选择中止。</li>
          <li>从结果导出本地 CSV，使用 ECharts 生成交互图。</li>
          <li>从图可见：不同工作日/人数的小费率存在显著差异；晚餐时段（Dinner）通常更高（结合图表解读）。</li>
        </ul>
      </div>
    </div>

    <footer>© 2025 Hadoop + Hive E2E Demo </footer>
  </div>

  <script>
    const data = {"byDay": [{"day": "Fri", "avg_tip_pct": 16.99, "stddev_tip_pct": 4.64, "n": 19}, {"day": "Sun", "avg_tip_pct": 16.69, "stddev_tip_pct": 8.42, "n": 76}, {"day": "Thur", "avg_tip_pct": 16.13, "stddev_tip_pct": 3.83, "n": 62}, {"day": "Sat", "avg_tip_pct": 15.32, "stddev_tip_pct": 5.1, "n": 87}], "bySize": [{"size": 1, "avg_tip_pct": 21.73, "n": 4}, {"size": 2, "avg_tip_pct": 16.57, "n": 156}, {"size": 3, "avg_tip_pct": 15.22, "n": 38}, {"size": 4, "avg_tip_pct": 14.59, "n": 37}, {"size": 5, "avg_tip_pct": 14.15, "n": 5}, {"size": 6, "avg_tip_pct": 15.62, "n": 4}], "heatmap": {"x": ["Thur", "Fri", "Sat", "Sun"], "y": ["Lunch", "Dinner"], "values": [[0, 0, 16.13], [1, 0, 18.88], [2, 0, null], [3, 0, null], [0, 1, 15.97], [1, 1, 15.89], [2, 1, 15.32], [3, 1, 16.69]]}, "summary": {"rows": 244, "avg_tip_pct": 16.08}, "generatedAt": "2025-10-22 09:37:00"};
    document.getElementById("genAt").innerText = data.generatedAt;
    document.getElementById("kpiRows").innerText = data.summary.rows || '-';
    document.getElementById("kpiAvg").innerText = (data.summary.avg_tip_pct ?? '-');
    // 新增：填充洞察文本
    if (data.insightByDay) {
      document.getElementById('insight-by-day').textContent = data.insightByDay;
    }
    if (data.insightBySize) {
      document.getElementById('insight-by-size').textContent = data.insightBySize;
    }

    // Chart 1: by day
    const c1 = echarts.init(document.getElementById('chartDay'));
    const dayNames = data.byDay.map(d => d.day);
    const dayVals = data.byDay.map(d => d.avg_tip_pct);
    c1.setOption({
      tooltip: {},
      xAxis: { type: 'category', data: dayNames, axisLabel: { color: '#e9eefb' } },
      yAxis: { type: 'value', axisLabel: { color: '#e9eefb' } },
      series: [{ type: 'bar', data: dayVals, itemStyle: { color: '#4F81BD' } }],
      grid: { left: 40, right: 20, top: 20, bottom: 40 },
      backgroundColor: 'transparent'
    });

    // Chart 2: by size
    const c2 = echarts.init(document.getElementById('chartSize'));
    const sizeNames = data.bySize.map(d => String(d.size));
    const sizeVals = data.bySize.map(d => d.avg_tip_pct);
    c2.setOption({
      tooltip: {},
      xAxis: { type: 'category', data: sizeNames, axisLabel: { color: '#e9eefb' } },
      yAxis: { type: 'value', axisLabel: { color: '#e9eefb' } },
      series: [{ type: 'bar', data: sizeVals, itemStyle: { color: '#9CCC65' } }],
      grid: { left: 40, right: 20, top: 20, bottom: 40 },
      backgroundColor: 'transparent'
    });

    // Chart 3: heatmap day x time
    const c3 = echarts.init(document.getElementById('chartHeat'));
    const hmX = data.heatmap.x, hmY = data.heatmap.y, hmVals = data.heatmap.values;
    c3.setOption({
      tooltip: {
        position: 'top',
        formatter: function (params) {
          // 如果值是 null 或 undefined，显示“无数据”
          if (params.value[2] == null) {
            return `${hmX[params.value[0]]}, ${hmY[params.value[1]]}<br/>无数据`;
          }
          // 否则正常显示
          return `${hmX[params.value[0]]}, ${hmY[params.value[1]]}<br/>平均小费率: <b>${params.value[2].toFixed(2)}%</b>`;
        }
      },
      xAxis: { type: 'category', data: hmX, axisLabel: { color: '#e9eefb' } },
      yAxis: { type: 'category', data: hmY, axisLabel: { color: '#e9eefb' } },
      visualMap: {
        // 动态计算 min/max，忽略 null
        min: Math.min(...hmVals.filter(v => v[2] !== null).map(v => v[2])),
        max: Math.max(...hmVals.filter(v => v[2] !== null).map(v => v[2])),
        calculable: true,
        orient: 'horizontal',
        left: 'center',
        bottom: 0,
        // 让 null 值对应的格子使用这个颜色（接近背景的深色）
        color: ['#151b33'], // 或者使用灰色 '#444'
        inRange: {
          // 这是有数值时的颜色范围
          color: ['#fef0d9', '#fdcc8a', '#fc8d59', '#d7301f']
        }
      },
      series: [{
        type: 'heatmap',
        data: hmVals,
        label: {
          show: true,
          formatter: function (params) {
            // 如果值是 null，标签不显示任何文字
            return params.value[2] == null ? '' : params.value[2].toFixed(2);
          }
        },
        emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.5)' } }
      }],
      grid: { left: 60, right: 40, top: 20, bottom: 60 },
      backgroundColor: 'transparent'
    });
    window.addEventListener('resize', () => { c1.resize(); c2.resize(); c3.resize(); });
  </script>
</body>

</html>